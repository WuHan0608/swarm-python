#!/usr/bin/env python2
# -*- coding: utf8 -*-

import argparse
from swarm import *

def add_parser(base_url, version):
    funcs = {
        'version': Version(base_url, version),
        'info': Info(base_url, version),
        'ps': Containers(base_url, version),
        'start': StartContainer(base_url, version),
        'stop': StopContainer(base_url, version),
        'restart': RestartContainer(base_url, version),
        'rm': RemoveContainer(base_url, version),
        'images': Images(base_url, version),
        'rmi': RemoveImage(base_url, version),
        'tag': Tag(base_url, version),
    }
    # create the top-level parser
    parser = argparse.ArgumentParser()
    subparsers = parser.add_subparsers()
    # create the parser for command 'swarm version'
    parser_version = subparsers.add_parser('version', help='Show the Docker version information.')
    parser_version.set_defaults(func=funcs['version'])
    # create the parser for command 'swarm info'
    parser_info = subparsers.add_parser('info', help='Display system-wide information')
    parser_info.set_defaults(func=funcs['info'])
    # create the parser for command 'swarm ps'
    parser_ps = subparsers.add_parser('ps', help='List containers')
    parser_ps.add_argument('-a', '--all',action='store_true',\
                            help='Show all containers (default shows just running)')
    parser_ps.add_argument('-f', '--filter',type=str,\
                            help='Filter output based on conditions provide, a comma-separated list')
    parser_ps.add_argument('-l','--limit',type=str,\
                            help='Show containers on nodes provide, a comma-separated list')
    parser_ps.set_defaults(func=funcs['ps'])
    # create the paser for command 'swarm start'
    parser_start = subparsers.add_parser('start', help='Start one or more stopped containers')
    parser_start.add_argument('CONTAINER',nargs='+', help='Container ID')
    parser_start.set_defaults(func=funcs['start'])
    # create the paser for command 'swarm stop'
    parser_start = subparsers.add_parser('stop',\
                            help='Stop a running container by sending SIGTERM and then SIGKILL after a grace period')
    parser_start.add_argument('CONTAINER',nargs='+', help='Container ID')
    parser_start.set_defaults(func=funcs['stop'])
    # create the paser for command 'swarm restart'
    parser_start = subparsers.add_parser('restart', help='Restart a running container')
    parser_start.add_argument('CONTAINER',nargs='+', help='Container ID')
    parser_start.set_defaults(func=funcs['restart'])
    # create the paser for command 'swarm rm'
    parser_start = subparsers.add_parser('rm', help='Remove one or more containers')
    parser_start.add_argument('CONTAINER',nargs='+', help='CONTAINER ID')
    parser_start.set_defaults(func=funcs['rm'])
    # create the parser for command 'swarm images'
    parser_images = subparsers.add_parser('images', help='List images')
    parser_images.add_argument('REPOSITORY', nargs='?', help='REPOSITORY NAME', default=None)
    parser_images.add_argument('-a', '--all', action='store_true',\
                                help='Show all images (default hides intermediate images)')
    parser_images.add_argument('-f','--filter',type=str,\
                                help='Filter output based on conditions provided, a comma-separated list')
    parser_images.set_defaults(func=funcs['images'])
    # create the parser for command 'swarm rmi'
    parser_rmi = subparsers.add_parser('rmi', help='Remove one or more images')
    parser_rmi.add_argument('IMAGE', nargs='+', help='IMAGE[:TAG]')
    parser_rmi.set_defaults(func=funcs['rmi'])
    # create the parser for command 'swarm tag'
    parser_tag = subparsers.add_parser('tag', help='Tag an image into a repository')
    parser_tag.add_argument('IMAGE', nargs=1, type=str, help='IMAGE[:TAG]')
    parser_tag.add_argument('REPOTAG', nargs=1, type=str, help='[REGISTRYHOST/][USERNAME/]NAME[:TAG]')
    parser_tag.set_defaults(func=funcs['tag'])
    return parser

def main(base_url, version):
    parser = add_parser(base_url, version)
    args = parser.parse_args()
    method = args.func.__class__.__name__
    if method in ('Version', 'Info'):
        args.func()
    elif method == 'Containers':
        filters = {}
        if args.filter:
            for item in args.filter.split(','):
                k, v = item.split('=')
                filters[k] = v
        if args.limit:
            limit = tuple(args.limit.split(','))
        else:
            limit = None
        args.func(show_all=args.all,filters=filters,limit=limit)
    elif method in ('Start', 'Stop', 'Restart', 'RemoveContainer'):
        args.func(tuple(args.CONTAINER))
    elif method == 'Images':
        filters = {}
        if args.filter:
            for item in args.filter.split(','):
                k, v = item.split('=')
                filters[k] = v
        args.func(name=args.REPOSITORY,show_all=args.all,filters=filters)
    elif method == 'RemoveImage':
        images = set()
        for image_name in args.IMAGE:
            # tag defaults to 'latest' if not provide
            if len(image_name.split(':')) == 1:
                image = ''.join((image_name.split(':')[0], ':', 'latest'))
            else:
                image = image_name
            images.add(image)
        args.func(tuple(images))
    elif method == 'Tag':
        repo_name = args.REPOTAG[0].split(':', 1)
        # tag defaults to 'latest' if not provide
        if len(repo_name) == 1:
            repo = repo_name[0]
            tag = 'latest'
        else:
            repo, tag = repo_name
        args.func(args.IMAGE[0], repo, tag)

if __name__ == '__main__':
    base_url = 'tcp://172.24.128.31:3375'
    version = '1.20'
    main(base_url, version)
