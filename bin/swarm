#!/usr/bin/env python2
# -*- coding: utf8 -*-

import argparse
from swarm import *

def add_parser(base_url, version):
    funcs = {
        'version': Version(base_url, version),
        'info': Info(base_url, version),
        'ps': Containers(base_url, version),
    }
    # create the top-level parser
    parser = argparse.ArgumentParser()
    subparsers = parser.add_subparsers()
    # create the parser for command 'version'
    parser_version = subparsers.add_parser('version')
    parser_version.set_defaults(func=funcs['version'])
    # create the parser for command 'info'
    parser_info = subparsers.add_parser('info')
    parser_info.set_defaults(func=funcs['info'])
    # create the parser for command 'ps'
    parser_ps = subparsers.add_parser('ps')
    parser_ps.add_argument('-a', '--all', help='Show all containers (default shows just running)',\
                                                                                action='store_true')
    parser_ps.add_argument('-f', '--filter', nargs='+', help='Filter output based on conditions provide')
    parser_ps.set_defaults(func=funcs['ps'])
    return parser

def main(base_url, version):
    parser = add_parser(base_url, version)
    args = parser.parse_args()
    clsname = args.func.__class__.__name__
    if clsname in ('Version', 'Info'):
        args.func()
    elif clsname == 'Containers':
        filters = {}
        if args.filter:
            for item in args.filter:
                k, v = item.split('=')
                filters[k] = v
        args.func(show_all=args.all,filters=filters)

if __name__ == '__main__':
    base_url = 'tcp://172.24.128.31:3375'
    version = '1.20'
    main(base_url, version)
